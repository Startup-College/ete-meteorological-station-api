<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <img class="mb-4" src="/public/assets/web-app-manifest-192x192.png" alt="" style="max-width: 120px;">
      <button id="logoutButton" class="btn btn-danger">Sair</button>
    </div>
    <div class="d-flex justify-content-between mb-3">
      <p>Bem-vindo à página de estações!</p>
      <a href="create-station.html" class="btn btn-primary">Cadastrar Estação</a>
    </div>

    <!-- Tornar a tabela responsiva -->
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead class="table-dark">
          <tr>
            <th class="text-center">ID</th>
            <th class="text-center">Nome</th>
            <th class="text-center">Latitude</th>
            <th class="text-center">Longitude</th>
            <th class="text-center">Ação</th>
          </tr>
        </thead>
        <tbody id="stationList">
          <!-- Dados das estações serão inseridos aqui dinamicamente -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function checkAuthentication() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Você não está autenticado!');
        window.location.href = '/public/index.html'; // Redireciona para a página de login
      }
    }

    function logout() {
      localStorage.removeItem('token'); // Remove o token do armazenamento
      alert('Você saiu com sucesso!');
      window.location.href = '/public/index.html'; // Redireciona para a página de login
    }

    async function fetchStations() {
      try {

        const token = localStorage.getItem('token');
        const response = await fetch('http://10.0.1.100:3333/api/v1/stations', {
          method: 'GET',
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        if (response.ok) {
          const stations = await response.json();
          const stationList = document.getElementById('stationList');
          stationList.innerHTML = '';

          stations.forEach((station) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="text-center">${station.id}</td>
                <td class="text-center">${station.name}</td>
                <td class="text-center">${station.latitude || 'N/A'}</td>
                <td class="text-center">${station.longitude || 'N/A'}</td>
                <td class="d-flex justify-content-center gap-3">
                  <button class="btn btn-info btn-sm" onclick="viewToken(${station.id})">Ver Token</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteStation(${station.id})">Excluir</button>
                </td>
              `;
            stationList.appendChild(row);
          });
        } else {
          alert('Erro ao buscar estações.');
        }
      } catch (error) {
        console.error('Erro ao carregar estações:', error);
        alert('Erro ao conectar ao servidor.');
      }
    }

    async function viewToken(id) {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`http://10.0.1.100:3333/api/v1/stations/${id}/token`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          alert(`Token: ${data.token}`);
        } else {
          const errorData = await response.json();
          alert(`Erro: ${errorData.error}`);
        }
      } catch (error) {
        console.error('Erro ao buscar token:', error);
        alert('Erro ao conectar ao servidor.');
      }
    }

    async function deleteStation(id) {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`http://10.0.1.100:3333/api/v1/stations/${id}`, {
          method: 'DELETE',
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        if (response.ok) {
          alert('Estação excluída com sucesso!');
          fetchStations();
        } else {
          const errorData = await response.json();
          alert(`Erro: ${errorData.error}`);
        }
      } catch (error) {
        console.error('Erro ao excluir estação:', error);
        alert('Erro ao conectar ao servidor.');
      }
    }

    // Adiciona evento ao botão de logout
    document.getElementById('logoutButton').addEventListener('click', logout);

    // Garante que o usuário esteja autenticado antes de carregar os dados
    checkAuthentication();
    window.onload = fetchStations;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>